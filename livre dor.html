<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Livre d'Or de l'Athénée</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        /* CSS de Base */
        body { text-align: center; font-family: sans-serif; background-color: #ffdab9; }
        h1 { color: #333; margin-top: 40px; }

        /* Styles des Témoignages */
        .temoignage {
            max-width: 650px;
            margin: 30px auto;
            padding: 20px;
            border-left: 5px solid #d35400;
            background-color: #fff8e1;
            font-style: italic;
            text-align: left;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .signature {
            text-align: right;
            font-style: normal;
            font-weight: bold;
            margin-top: 10px;
        }
        .retour-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<a href="index.html" class="retour-btn">← Retour à la Page d'Accueil</a>

<section id="livre-dor">
    <h1>Les Messages des élèves.</h1>
</section>

<script>
    // **1. URL CORRIGÉE AVEC PROXY CORS**
    // Cette URL DOIT être la seule ligne active. L'ID est basé sur votre capture.
    const SHEET_URL = 'https://cors-anywhere.herokuapp.com/https://docs.google.com/spreadsheets/d/e/2PACX-1vTlmtMeaYEXiGLzk0tW2KJY-Ca5Qob7YeZbk3xsrNIC_vUAG2ZFN3LcVV7u9FPSEwRVbLib-1xmAtXe/pub?output=csv';
    const CONTENEUR = document.getElementById('livre-dor');

    // **2. FONCTION parseCSV FINALE (Force le point-virgule)**
    function parseCSV(text) {
        if (!text || text.length < 10) return [];
        
        // On FORCE le séparateur à point-virgule (Séparateur des régions francophones)
        const SEPARATEUR = ';';

        const rows = text.split('\n');
        const messages = [];

        // Commencer à i=1 pour ignorer la ligne d'en-tête
        for (let i = 1; i < rows.length; i++) {
            // Split chaque ligne avec le séparateur forcé
            const row = rows[i].split(SEPARATEUR);
            
            // On vérifie si on a au moins 4 colonnes (A, B, C, D)
            if (row.length < 4) continue; 

            const message = {};
            
            // **3. INDEX DES COLONNES CONFIRMÉS (1=Nom, 2=Année, 3=Message)**
            // Nettoyage et assignation des valeurs
            message.Nom = row[1] ? row[1].replace(/"/g, '').trim() : 'Anonyme';
            message.Annee = row[2] ? row[2].replace(/"/g, '').trim() : '';
            message.Message = row[3] ? row[3].replace(/"/g, '').trim() : 'Pas de message.';

            // Ajoute le message seulement s'il y a du contenu
            if (message.Message !== 'Pas de message.') {
                messages.push(message);
            }
        }
        return messages;
    }

    // Fonction principale pour charger et afficher les messages
    async function afficherMessages() {
        try {
            const response = await fetch(SHEET_URL);

            if (!response.ok) {
                // Si le CORS échoue à cause du proxy non débloqué
                throw new Error('Erreur de connexion. Avez-vous débloqué le proxy CORS ?');
            }

            const csvText = await response.text();

            const messages = parseCSV(csvText);

            // Si le code lit mais ne trouve rien (seulement l'en-tête + lignes vides)
            if (messages.length === 0) {
                CONTENEUR.innerHTML += "<p style='text-align:center;'>Aucun message n'a encore été soumis ! Soyez le premier !</p>";
                return;
            }

            messages.forEach(msg => {
                const divMessage = document.createElement('div');
                divMessage.className = 'temoignage';

                divMessage.innerHTML = `
                    <p>${msg.Message}</p>
                    <p class="signature">- ${msg.Nom}, promotion ${msg.Annee}</p>
                `;
                CONTENEUR.appendChild(divMessage);
            });

        } catch (error) {
            console.error("Erreur critique:", error);
            // Ce message d'erreur s'affiche si la connexion échoue (problème CORS ou URL)
            CONTENEUR.innerHTML += "<p style='text-align:center; color:red;'>Oups ! Impossible de charger les messages pour le moment. Vérifiez le lien du proxy.</p>";
        }
    }

    // Déclenche l'affichage quand la page est chargée
    afficherMessages();

</script>
</body>
</html>

